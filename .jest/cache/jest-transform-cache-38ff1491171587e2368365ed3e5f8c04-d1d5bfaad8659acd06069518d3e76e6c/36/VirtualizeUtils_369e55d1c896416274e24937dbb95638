fb2d56d3203092efe75118f2b7cd841d
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.computeWindowedRenderLimits = computeWindowedRenderLimits;
exports.elementsThatOverlapOffsets = elementsThatOverlapOffsets;
exports.keyExtractor = keyExtractor;
exports.newRangeCount = newRangeCount;
var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));
var _invariant = _interopRequireDefault(require("invariant"));
function elementsThatOverlapOffsets(offsets, itemCount, getFrameMetrics) {
  var zoomScale = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 1;
  var result = [];
  for (var offsetIndex = 0; offsetIndex < offsets.length; offsetIndex++) {
    var currentOffset = offsets[offsetIndex];
    var left = 0;
    var right = itemCount - 1;
    while (left <= right) {
      var mid = left + (right - left >>> 1);
      var frame = getFrameMetrics(mid);
      var scaledOffsetStart = frame.offset * zoomScale;
      var scaledOffsetEnd = (frame.offset + frame.length) * zoomScale;
      if (mid === 0 && currentOffset < scaledOffsetStart || mid !== 0 && currentOffset <= scaledOffsetStart) {
        right = mid - 1;
      } else if (currentOffset > scaledOffsetEnd) {
        left = mid + 1;
      } else {
        result[offsetIndex] = mid;
        break;
      }
    }
  }
  return result;
}
function newRangeCount(prev, next) {
  return next.last - next.first + 1 - Math.max(0, 1 + Math.min(next.last, prev.last) - Math.max(next.first, prev.first));
}
function computeWindowedRenderLimits(data, getItemCount, maxToRenderPerBatch, windowSize, prev, getFrameMetricsApprox, scrollMetrics) {
  var itemCount = getItemCount(data);
  if (itemCount === 0) {
    return prev;
  }
  var offset = scrollMetrics.offset,
    velocity = scrollMetrics.velocity,
    visibleLength = scrollMetrics.visibleLength,
    _scrollMetrics$zoomSc = scrollMetrics.zoomScale,
    zoomScale = _scrollMetrics$zoomSc === void 0 ? 1 : _scrollMetrics$zoomSc;
  var visibleBegin = Math.max(0, offset);
  var visibleEnd = visibleBegin + visibleLength;
  var overscanLength = (windowSize - 1) * visibleLength;
  var leadFactor = 0.5;
  var fillPreference = velocity > 1 ? 'after' : velocity < -1 ? 'before' : 'none';
  var overscanBegin = Math.max(0, visibleBegin - (1 - leadFactor) * overscanLength);
  var overscanEnd = Math.max(0, visibleEnd + leadFactor * overscanLength);
  var lastItemOffset = getFrameMetricsApprox(itemCount - 1).offset * zoomScale;
  if (lastItemOffset < overscanBegin) {
    return {
      first: Math.max(0, itemCount - 1 - maxToRenderPerBatch),
      last: itemCount - 1
    };
  }
  var _elementsThatOverlapO = elementsThatOverlapOffsets([overscanBegin, visibleBegin, visibleEnd, overscanEnd], itemCount, getFrameMetricsApprox, zoomScale),
    _elementsThatOverlapO2 = (0, _slicedToArray2.default)(_elementsThatOverlapO, 4),
    overscanFirst = _elementsThatOverlapO2[0],
    first = _elementsThatOverlapO2[1],
    last = _elementsThatOverlapO2[2],
    overscanLast = _elementsThatOverlapO2[3];
  overscanFirst = overscanFirst == null ? 0 : overscanFirst;
  first = first == null ? Math.max(0, overscanFirst) : first;
  overscanLast = overscanLast == null ? itemCount - 1 : overscanLast;
  last = last == null ? Math.min(overscanLast, first + maxToRenderPerBatch - 1) : last;
  var visible = {
    first: first,
    last: last
  };
  var newCellCount = newRangeCount(prev, visible);
  while (true) {
    if (first <= overscanFirst && last >= overscanLast) {
      break;
    }
    var maxNewCells = newCellCount >= maxToRenderPerBatch;
    var firstWillAddMore = first <= prev.first || first > prev.last;
    var firstShouldIncrement = first > overscanFirst && (!maxNewCells || !firstWillAddMore);
    var lastWillAddMore = last >= prev.last || last < prev.first;
    var lastShouldIncrement = last < overscanLast && (!maxNewCells || !lastWillAddMore);
    if (maxNewCells && !firstShouldIncrement && !lastShouldIncrement) {
      break;
    }
    if (firstShouldIncrement && !(fillPreference === 'after' && lastShouldIncrement && lastWillAddMore)) {
      if (firstWillAddMore) {
        newCellCount++;
      }
      first--;
    }
    if (lastShouldIncrement && !(fillPreference === 'before' && firstShouldIncrement && firstWillAddMore)) {
      if (lastWillAddMore) {
        newCellCount++;
      }
      last++;
    }
  }
  if (!(last >= first && first >= 0 && last < itemCount && first >= overscanFirst && last <= overscanLast && first <= visible.first && last >= visible.last)) {
    throw new Error('Bad window calculation ' + JSON.stringify({
      first: first,
      last: last,
      itemCount: itemCount,
      overscanFirst: overscanFirst,
      overscanLast: overscanLast,
      visible: visible
    }));
  }
  return {
    first: first,
    last: last
  };
}
function keyExtractor(item, index) {
  if (typeof item === 'object' && (item == null ? void 0 : item.key) != null) {
    return item.key;
  }
  if (typeof item === 'object' && (item == null ? void 0 : item.id) != null) {
    return item.id;
  }
  return String(index);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cyIsIm9mZnNldHMiLCJpdGVtQ291bnQiLCJnZXRGcmFtZU1ldHJpY3MiLCJ6b29tU2NhbGUiLCJyZXN1bHQiLCJvZmZzZXRJbmRleCIsImxlbmd0aCIsImN1cnJlbnRPZmZzZXQiLCJsZWZ0IiwicmlnaHQiLCJtaWQiLCJmcmFtZSIsInNjYWxlZE9mZnNldFN0YXJ0Iiwib2Zmc2V0Iiwic2NhbGVkT2Zmc2V0RW5kIiwibmV3UmFuZ2VDb3VudCIsInByZXYiLCJuZXh0IiwibGFzdCIsImZpcnN0IiwiTWF0aCIsIm1heCIsIm1pbiIsImNvbXB1dGVXaW5kb3dlZFJlbmRlckxpbWl0cyIsImRhdGEiLCJnZXRJdGVtQ291bnQiLCJtYXhUb1JlbmRlclBlckJhdGNoIiwid2luZG93U2l6ZSIsImdldEZyYW1lTWV0cmljc0FwcHJveCIsInNjcm9sbE1ldHJpY3MiLCJ2ZWxvY2l0eSIsInZpc2libGVMZW5ndGgiLCJ2aXNpYmxlQmVnaW4iLCJ2aXNpYmxlRW5kIiwib3ZlcnNjYW5MZW5ndGgiLCJsZWFkRmFjdG9yIiwiZmlsbFByZWZlcmVuY2UiLCJvdmVyc2NhbkJlZ2luIiwib3ZlcnNjYW5FbmQiLCJsYXN0SXRlbU9mZnNldCIsIm92ZXJzY2FuRmlyc3QiLCJvdmVyc2Nhbkxhc3QiLCJ2aXNpYmxlIiwibmV3Q2VsbENvdW50IiwibWF4TmV3Q2VsbHMiLCJmaXJzdFdpbGxBZGRNb3JlIiwiZmlyc3RTaG91bGRJbmNyZW1lbnQiLCJsYXN0V2lsbEFkZE1vcmUiLCJsYXN0U2hvdWxkSW5jcmVtZW50IiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5Iiwia2V5RXh0cmFjdG9yIiwiaXRlbSIsImluZGV4Iiwia2V5IiwiaWQiLCJTdHJpbmciXSwic291cmNlcyI6WyJWaXJ0dWFsaXplVXRpbHMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2ludmFyaWFudCc7XG5cbi8qKlxuICogVXNlZCB0byBmaW5kIHRoZSBpbmRpY2VzIG9mIHRoZSBmcmFtZXMgdGhhdCBvdmVybGFwIHRoZSBnaXZlbiBvZmZzZXRzLiBVc2VmdWwgZm9yIGZpbmRpbmcgdGhlXG4gKiBpdGVtcyB0aGF0IGJvdW5kIGRpZmZlcmVudCB3aW5kb3dzIG9mIGNvbnRlbnQsIHN1Y2ggYXMgdGhlIHZpc2libGUgYXJlYSBvciB0aGUgYnVmZmVyZWQgb3ZlcnNjYW5cbiAqIGFyZWEuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cyhcbiAgb2Zmc2V0czogQXJyYXk8bnVtYmVyPixcbiAgaXRlbUNvdW50OiBudW1iZXIsXG4gIGdldEZyYW1lTWV0cmljczogKGluZGV4OiBudW1iZXIpID0+IHtcbiAgICBsZW5ndGg6IG51bWJlcixcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICAuLi5cbiAgfSxcbiAgem9vbVNjYWxlOiBudW1iZXIgPSAxLFxuKTogQXJyYXk8bnVtYmVyPiB7XG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuICBmb3IgKGxldCBvZmZzZXRJbmRleCA9IDA7IG9mZnNldEluZGV4IDwgb2Zmc2V0cy5sZW5ndGg7IG9mZnNldEluZGV4KyspIHtcbiAgICBjb25zdCBjdXJyZW50T2Zmc2V0ID0gb2Zmc2V0c1tvZmZzZXRJbmRleF07XG4gICAgbGV0IGxlZnQgPSAwO1xuICAgIGxldCByaWdodCA9IGl0ZW1Db3VudCAtIDE7XG5cbiAgICB3aGlsZSAobGVmdCA8PSByaWdodCkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2VcbiAgICAgIGNvbnN0IG1pZCA9IGxlZnQgKyAoKHJpZ2h0IC0gbGVmdCkgPj4+IDEpO1xuICAgICAgY29uc3QgZnJhbWUgPSBnZXRGcmFtZU1ldHJpY3MobWlkKTtcbiAgICAgIGNvbnN0IHNjYWxlZE9mZnNldFN0YXJ0ID0gZnJhbWUub2Zmc2V0ICogem9vbVNjYWxlO1xuICAgICAgY29uc3Qgc2NhbGVkT2Zmc2V0RW5kID0gKGZyYW1lLm9mZnNldCArIGZyYW1lLmxlbmd0aCkgKiB6b29tU2NhbGU7XG5cbiAgICAgIC8vIFdlIHdhbnQgdGhlIGZpcnN0IGZyYW1lIHRoYXQgY29udGFpbnMgdGhlIG9mZnNldCwgd2l0aCBpbmNsdXNpdmUgYm91bmRzLiBUaHVzLCBmb3IgdGhlXG4gICAgICAvLyBmaXJzdCBmcmFtZSB0aGUgc2NhbGVkT2Zmc2V0U3RhcnQgaXMgaW5jbHVzaXZlLCB3aGlsZSBmb3Igb3RoZXIgZnJhbWVzIGl0IGlzIGV4Y2x1c2l2ZS5cbiAgICAgIGlmIChcbiAgICAgICAgKG1pZCA9PT0gMCAmJiBjdXJyZW50T2Zmc2V0IDwgc2NhbGVkT2Zmc2V0U3RhcnQpIHx8XG4gICAgICAgIChtaWQgIT09IDAgJiYgY3VycmVudE9mZnNldCA8PSBzY2FsZWRPZmZzZXRTdGFydClcbiAgICAgICkge1xuICAgICAgICByaWdodCA9IG1pZCAtIDE7XG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRPZmZzZXQgPiBzY2FsZWRPZmZzZXRFbmQpIHtcbiAgICAgICAgbGVmdCA9IG1pZCArIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRbb2Zmc2V0SW5kZXhdID0gbWlkO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIENvbXB1dGVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIGBuZXh0YCByYW5nZSB0aGF0IGFyZSBuZXcgY29tcGFyZWQgdG8gdGhlIGBwcmV2YCByYW5nZS5cbiAqIEhhbmR5IGZvciBjYWxjdWxhdGluZyBob3cgbWFueSBuZXcgaXRlbXMgd2lsbCBiZSByZW5kZXJlZCB3aGVuIHRoZSByZW5kZXIgd2luZG93IGNoYW5nZXMgc28gd2VcbiAqIGNhbiByZXN0cmljdCB0aGUgbnVtYmVyIG9mIG5ldyBpdGVtcyByZW5kZXIgYXQgb25jZSBzbyB0aGF0IGNvbnRlbnQgY2FuIGFwcGVhciBvbiB0aGUgc2NyZWVuXG4gKiBmYXN0ZXIuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBuZXdSYW5nZUNvdW50KFxuICBwcmV2OiB7XG4gICAgZmlyc3Q6IG51bWJlcixcbiAgICBsYXN0OiBudW1iZXIsXG4gICAgLi4uXG4gIH0sXG4gIG5leHQ6IHtcbiAgICBmaXJzdDogbnVtYmVyLFxuICAgIGxhc3Q6IG51bWJlcixcbiAgICAuLi5cbiAgfSxcbik6IG51bWJlciB7XG4gIHJldHVybiAoXG4gICAgbmV4dC5sYXN0IC1cbiAgICBuZXh0LmZpcnN0ICtcbiAgICAxIC1cbiAgICBNYXRoLm1heChcbiAgICAgIDAsXG4gICAgICAxICsgTWF0aC5taW4obmV4dC5sYXN0LCBwcmV2Lmxhc3QpIC0gTWF0aC5tYXgobmV4dC5maXJzdCwgcHJldi5maXJzdCksXG4gICAgKVxuICApO1xufVxuXG4vKipcbiAqIEN1c3RvbSBsb2dpYyBmb3IgZGV0ZXJtaW5pbmcgd2hpY2ggaXRlbXMgc2hvdWxkIGJlIHJlbmRlcmVkIGdpdmVuIHRoZSBjdXJyZW50IGZyYW1lIGFuZCBzY3JvbGxcbiAqIG1ldHJpY3MsIGFzIHdlbGwgYXMgdGhlIHByZXZpb3VzIHJlbmRlciBzdGF0ZS4gVGhlIGFsZ29yaXRobSBtYXkgZXZvbHZlIG92ZXIgdGltZSwgYnV0IGdlbmVyYWxseVxuICogcHJpb3JpdGl6ZXMgdGhlIHZpc2libGUgYXJlYSBmaXJzdCwgdGhlbiBleHBhbmRzIHRoYXQgd2l0aCBvdmVyc2NhbiByZWdpb25zIGFoZWFkIGFuZCBiZWhpbmQsXG4gKiBiaWFzZWQgaW4gdGhlIGRpcmVjdGlvbiBvZiBzY3JvbGwuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHMoXG4gIGRhdGE6IGFueSxcbiAgZ2V0SXRlbUNvdW50OiAoZGF0YTogYW55KSA9PiBudW1iZXIsXG4gIG1heFRvUmVuZGVyUGVyQmF0Y2g6IG51bWJlcixcbiAgd2luZG93U2l6ZTogbnVtYmVyLFxuICBwcmV2OiB7XG4gICAgZmlyc3Q6IG51bWJlcixcbiAgICBsYXN0OiBudW1iZXIsXG4gICAgLi4uXG4gIH0sXG4gIGdldEZyYW1lTWV0cmljc0FwcHJveDogKGluZGV4OiBudW1iZXIpID0+IHtcbiAgICBsZW5ndGg6IG51bWJlcixcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICAuLi5cbiAgfSxcbiAgc2Nyb2xsTWV0cmljczoge1xuICAgIGR0OiBudW1iZXIsXG4gICAgb2Zmc2V0OiBudW1iZXIsXG4gICAgdmVsb2NpdHk6IG51bWJlcixcbiAgICB2aXNpYmxlTGVuZ3RoOiBudW1iZXIsXG4gICAgem9vbVNjYWxlOiBudW1iZXIsXG4gICAgLi4uXG4gIH0sXG4pOiB7XG4gIGZpcnN0OiBudW1iZXIsXG4gIGxhc3Q6IG51bWJlcixcbiAgLi4uXG59IHtcbiAgY29uc3QgaXRlbUNvdW50ID0gZ2V0SXRlbUNvdW50KGRhdGEpO1xuICBpZiAoaXRlbUNvdW50ID09PSAwKSB7XG4gICAgcmV0dXJuIHByZXY7XG4gIH1cbiAgY29uc3Qge29mZnNldCwgdmVsb2NpdHksIHZpc2libGVMZW5ndGgsIHpvb21TY2FsZSA9IDF9ID0gc2Nyb2xsTWV0cmljcztcblxuICAvLyBTdGFydCB3aXRoIHZpc2libGUgYXJlYSwgdGhlbiBjb21wdXRlIG1heGltdW0gb3ZlcnNjYW4gcmVnaW9uIGJ5IGV4cGFuZGluZyBmcm9tIHRoZXJlLCBiaWFzZWRcbiAgLy8gaW4gdGhlIGRpcmVjdGlvbiBvZiBzY3JvbGwuIFRvdGFsIG92ZXJzY2FuIGFyZWEgaXMgY2FwcGVkLCB3aGljaCBzaG91bGQgY2FwIG1lbW9yeSBjb25zdW1wdGlvblxuICAvLyB0b28uXG4gIGNvbnN0IHZpc2libGVCZWdpbiA9IE1hdGgubWF4KDAsIG9mZnNldCk7XG4gIGNvbnN0IHZpc2libGVFbmQgPSB2aXNpYmxlQmVnaW4gKyB2aXNpYmxlTGVuZ3RoO1xuICBjb25zdCBvdmVyc2Nhbkxlbmd0aCA9ICh3aW5kb3dTaXplIC0gMSkgKiB2aXNpYmxlTGVuZ3RoO1xuXG4gIC8vIENvbnNpZGVyaW5nIHZlbG9jaXR5IHNlZW1zIHRvIGludHJvZHVjZSBtb3JlIGNodXJuIHRoYW4gaXQncyB3b3J0aC5cbiAgY29uc3QgbGVhZEZhY3RvciA9IDAuNTsgLy8gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdmVsb2NpdHkgLyAyNSArIDAuNSkpO1xuXG4gIGNvbnN0IGZpbGxQcmVmZXJlbmNlID1cbiAgICB2ZWxvY2l0eSA+IDEgPyAnYWZ0ZXInIDogdmVsb2NpdHkgPCAtMSA/ICdiZWZvcmUnIDogJ25vbmUnO1xuXG4gIGNvbnN0IG92ZXJzY2FuQmVnaW4gPSBNYXRoLm1heChcbiAgICAwLFxuICAgIHZpc2libGVCZWdpbiAtICgxIC0gbGVhZEZhY3RvcikgKiBvdmVyc2Nhbkxlbmd0aCxcbiAgKTtcbiAgY29uc3Qgb3ZlcnNjYW5FbmQgPSBNYXRoLm1heCgwLCB2aXNpYmxlRW5kICsgbGVhZEZhY3RvciAqIG92ZXJzY2FuTGVuZ3RoKTtcblxuICBjb25zdCBsYXN0SXRlbU9mZnNldCA9XG4gICAgZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGl0ZW1Db3VudCAtIDEpLm9mZnNldCAqIHpvb21TY2FsZTtcbiAgaWYgKGxhc3RJdGVtT2Zmc2V0IDwgb3ZlcnNjYW5CZWdpbikge1xuICAgIC8vIEVudGlyZSBsaXN0IGlzIGJlZm9yZSBvdXIgb3ZlcnNjYW4gd2luZG93XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpcnN0OiBNYXRoLm1heCgwLCBpdGVtQ291bnQgLSAxIC0gbWF4VG9SZW5kZXJQZXJCYXRjaCksXG4gICAgICBsYXN0OiBpdGVtQ291bnQgLSAxLFxuICAgIH07XG4gIH1cblxuICAvLyBGaW5kIHRoZSBpbmRpY2VzIHRoYXQgY29ycmVzcG9uZCB0byB0aGUgaXRlbXMgYXQgdGhlIHJlbmRlciBib3VuZGFyaWVzIHdlJ3JlIHRhcmdldGluZy5cbiAgbGV0IFtvdmVyc2NhbkZpcnN0LCBmaXJzdCwgbGFzdCwgb3ZlcnNjYW5MYXN0XSA9IGVsZW1lbnRzVGhhdE92ZXJsYXBPZmZzZXRzKFxuICAgIFtvdmVyc2NhbkJlZ2luLCB2aXNpYmxlQmVnaW4sIHZpc2libGVFbmQsIG92ZXJzY2FuRW5kXSxcbiAgICBpdGVtQ291bnQsXG4gICAgZ2V0RnJhbWVNZXRyaWNzQXBwcm94LFxuICAgIHpvb21TY2FsZSxcbiAgKTtcbiAgb3ZlcnNjYW5GaXJzdCA9IG92ZXJzY2FuRmlyc3QgPT0gbnVsbCA/IDAgOiBvdmVyc2NhbkZpcnN0O1xuICBmaXJzdCA9IGZpcnN0ID09IG51bGwgPyBNYXRoLm1heCgwLCBvdmVyc2NhbkZpcnN0KSA6IGZpcnN0O1xuICBvdmVyc2Nhbkxhc3QgPSBvdmVyc2Nhbkxhc3QgPT0gbnVsbCA/IGl0ZW1Db3VudCAtIDEgOiBvdmVyc2Nhbkxhc3Q7XG4gIGxhc3QgPVxuICAgIGxhc3QgPT0gbnVsbFxuICAgICAgPyBNYXRoLm1pbihvdmVyc2Nhbkxhc3QsIGZpcnN0ICsgbWF4VG9SZW5kZXJQZXJCYXRjaCAtIDEpXG4gICAgICA6IGxhc3Q7XG4gIGNvbnN0IHZpc2libGUgPSB7Zmlyc3QsIGxhc3R9O1xuXG4gIC8vIFdlIHdhbnQgdG8gbGltaXQgdGhlIG51bWJlciBvZiBuZXcgY2VsbHMgd2UncmUgcmVuZGVyaW5nIHBlciBiYXRjaCBzbyB0aGF0IHdlIGNhbiBmaWxsIHRoZVxuICAvLyBjb250ZW50IG9uIHRoZSBzY3JlZW4gcXVpY2tseS4gSWYgd2UgcmVuZGVyZWQgdGhlIGVudGlyZSBvdmVyc2NhbiB3aW5kb3cgYXQgb25jZSwgdGhlIHVzZXJcbiAgLy8gY291bGQgYmUgc3RhcmluZyBhdCB3aGl0ZSBzcGFjZSBmb3IgYSBsb25nIHRpbWUgd2FpdGluZyBmb3IgYSBidW5jaCBvZiBvZmZzY3JlZW4gY29udGVudCB0b1xuICAvLyByZW5kZXIuXG4gIGxldCBuZXdDZWxsQ291bnQgPSBuZXdSYW5nZUNvdW50KHByZXYsIHZpc2libGUpO1xuXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgaWYgKGZpcnN0IDw9IG92ZXJzY2FuRmlyc3QgJiYgbGFzdCA+PSBvdmVyc2Nhbkxhc3QpIHtcbiAgICAgIC8vIElmIHdlIGZpbGwgdGhlIGVudGlyZSBvdmVyc2NhbiByYW5nZSwgd2UncmUgZG9uZS5cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjb25zdCBtYXhOZXdDZWxscyA9IG5ld0NlbGxDb3VudCA+PSBtYXhUb1JlbmRlclBlckJhdGNoO1xuICAgIGNvbnN0IGZpcnN0V2lsbEFkZE1vcmUgPSBmaXJzdCA8PSBwcmV2LmZpcnN0IHx8IGZpcnN0ID4gcHJldi5sYXN0O1xuICAgIGNvbnN0IGZpcnN0U2hvdWxkSW5jcmVtZW50ID1cbiAgICAgIGZpcnN0ID4gb3ZlcnNjYW5GaXJzdCAmJiAoIW1heE5ld0NlbGxzIHx8ICFmaXJzdFdpbGxBZGRNb3JlKTtcbiAgICBjb25zdCBsYXN0V2lsbEFkZE1vcmUgPSBsYXN0ID49IHByZXYubGFzdCB8fCBsYXN0IDwgcHJldi5maXJzdDtcbiAgICBjb25zdCBsYXN0U2hvdWxkSW5jcmVtZW50ID1cbiAgICAgIGxhc3QgPCBvdmVyc2Nhbkxhc3QgJiYgKCFtYXhOZXdDZWxscyB8fCAhbGFzdFdpbGxBZGRNb3JlKTtcbiAgICBpZiAobWF4TmV3Q2VsbHMgJiYgIWZpcnN0U2hvdWxkSW5jcmVtZW50ICYmICFsYXN0U2hvdWxkSW5jcmVtZW50KSB7XG4gICAgICAvLyBXZSBvbmx5IHdhbnQgdG8gc3RvcCBpZiB3ZSd2ZSBoaXQgbWF4TmV3Q2VsbHMgQU5EIHdlIGNhbm5vdCBpbmNyZW1lbnQgZmlyc3Qgb3IgbGFzdFxuICAgICAgLy8gd2l0aG91dCByZW5kZXJpbmcgbmV3IGl0ZW1zLiBUaGlzIGxldCdzIHVzIHByZXNlcnZlIGFzIG1hbnkgYWxyZWFkeSByZW5kZXJlZCBpdGVtcyBhc1xuICAgICAgLy8gcG9zc2libGUsIHJlZHVjaW5nIHJlbmRlciBjaHVybiBhbmQga2VlcGluZyB0aGUgcmVuZGVyZWQgb3ZlcnNjYW4gcmFuZ2UgYXMgbGFyZ2UgYXNcbiAgICAgIC8vIHBvc3NpYmxlLlxuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGZpcnN0U2hvdWxkSW5jcmVtZW50ICYmXG4gICAgICAhKGZpbGxQcmVmZXJlbmNlID09PSAnYWZ0ZXInICYmIGxhc3RTaG91bGRJbmNyZW1lbnQgJiYgbGFzdFdpbGxBZGRNb3JlKVxuICAgICkge1xuICAgICAgaWYgKGZpcnN0V2lsbEFkZE1vcmUpIHtcbiAgICAgICAgbmV3Q2VsbENvdW50Kys7XG4gICAgICB9XG4gICAgICBmaXJzdC0tO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBsYXN0U2hvdWxkSW5jcmVtZW50ICYmXG4gICAgICAhKGZpbGxQcmVmZXJlbmNlID09PSAnYmVmb3JlJyAmJiBmaXJzdFNob3VsZEluY3JlbWVudCAmJiBmaXJzdFdpbGxBZGRNb3JlKVxuICAgICkge1xuICAgICAgaWYgKGxhc3RXaWxsQWRkTW9yZSkge1xuICAgICAgICBuZXdDZWxsQ291bnQrKztcbiAgICAgIH1cbiAgICAgIGxhc3QrKztcbiAgICB9XG4gIH1cbiAgaWYgKFxuICAgICEoXG4gICAgICBsYXN0ID49IGZpcnN0ICYmXG4gICAgICBmaXJzdCA+PSAwICYmXG4gICAgICBsYXN0IDwgaXRlbUNvdW50ICYmXG4gICAgICBmaXJzdCA+PSBvdmVyc2NhbkZpcnN0ICYmXG4gICAgICBsYXN0IDw9IG92ZXJzY2FuTGFzdCAmJlxuICAgICAgZmlyc3QgPD0gdmlzaWJsZS5maXJzdCAmJlxuICAgICAgbGFzdCA+PSB2aXNpYmxlLmxhc3RcbiAgICApXG4gICkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdCYWQgd2luZG93IGNhbGN1bGF0aW9uICcgK1xuICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmlyc3QsXG4gICAgICAgICAgbGFzdCxcbiAgICAgICAgICBpdGVtQ291bnQsXG4gICAgICAgICAgb3ZlcnNjYW5GaXJzdCxcbiAgICAgICAgICBvdmVyc2Nhbkxhc3QsXG4gICAgICAgICAgdmlzaWJsZSxcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuICByZXR1cm4ge2ZpcnN0LCBsYXN0fTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGtleUV4dHJhY3RvcihpdGVtOiBhbnksIGluZGV4OiBudW1iZXIpOiBzdHJpbmcge1xuICBpZiAodHlwZW9mIGl0ZW0gPT09ICdvYmplY3QnICYmIGl0ZW0/LmtleSAhPSBudWxsKSB7XG4gICAgcmV0dXJuIGl0ZW0ua2V5O1xuICB9XG4gIGlmICh0eXBlb2YgaXRlbSA9PT0gJ29iamVjdCcgJiYgaXRlbT8uaWQgIT0gbnVsbCkge1xuICAgIHJldHVybiBpdGVtLmlkO1xuICB9XG4gIHJldHVybiBTdHJpbmcoaW5kZXgpO1xufVxuIl0sIm1hcHBpbmdzIjoiQUFVQSxZQUFZOztBQUFDO0FBQUE7RUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUViO0FBT08sU0FBU0EsMEJBQTBCLENBQ3hDQyxPQUFzQixFQUN0QkMsU0FBaUIsRUFDakJDLGVBSUMsRUFFYztFQUFBLElBRGZDLFNBQWlCLHVFQUFHLENBQUM7RUFFckIsSUFBTUMsTUFBTSxHQUFHLEVBQUU7RUFDakIsS0FBSyxJQUFJQyxXQUFXLEdBQUcsQ0FBQyxFQUFFQSxXQUFXLEdBQUdMLE9BQU8sQ0FBQ00sTUFBTSxFQUFFRCxXQUFXLEVBQUUsRUFBRTtJQUNyRSxJQUFNRSxhQUFhLEdBQUdQLE9BQU8sQ0FBQ0ssV0FBVyxDQUFDO0lBQzFDLElBQUlHLElBQUksR0FBRyxDQUFDO0lBQ1osSUFBSUMsS0FBSyxHQUFHUixTQUFTLEdBQUcsQ0FBQztJQUV6QixP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